{{/* Series 信息卡片组件

  在文章顶部显示当前文章所属的 Series 信息
  包括 Series 名称、进度、快速导航链接

  @context {page} . 当前文章页面对象
*/}}

{{- $globalSeriesConfig := .Site.Params.series | default dict }}
{{- $seriesEnabled := $globalSeriesConfig.enabled | default false }}
{{- $showProgress := $globalSeriesConfig.showProgress | default true }}
{{- $showInHeader := $globalSeriesConfig.showInHeader | default true }}

{{/* frontmatter 参数覆盖 */}}
{{- if isset .Params "series" }}
  {{- if reflect.IsMap .Params.series }}
    {{- if isset .Params.series "enabled" }}
      {{- $seriesEnabled = .Params.series.enabled }}
    {{- end }}
    {{- if isset .Params.series "showInHeader" }}
      {{- $showInHeader = .Params.series.showInHeader }}
    {{- end }}
  {{- end }}
{{- end }}

{{/* 获取当前页面所属的 series */}}
{{- $currentSeries := .GetTerms "series" }}
{{- $seriesPages := slice }}
{{- $currentIndex := 0 }}
{{- $totalCount := 0 }}
{{- $prevPage := "" }}
{{- $nextPage := "" }}

{{- if $currentSeries }}
  {{- $seriesPage := index $currentSeries 0 }}
  {{- $seriesPages = $seriesPage.Pages.ByParam "series_order" }}
  {{- $totalCount = len $seriesPages }}
  
  {{/* 找到当前页面在系列中的位置 */}}
  {{- range $index, $page := $seriesPages }}
    {{- if eq $page.RelPermalink $.RelPermalink }}
      {{- $currentIndex = add $index 1 }}
      {{/* 获取上一篇和下一篇 */}}
      {{- if gt $index 0 }}
        {{- $prevPage = index $seriesPages (sub $index 1) }}
      {{- end }}
      {{- if lt (add $index 1) $totalCount }}
        {{- $nextPage = index $seriesPages (add $index 1) }}
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}

{{/* 只在启用且有 Series 且配置显示在 header 时显示 */}}
{{- if and .IsPage $seriesEnabled $currentSeries $showInHeader }}
  {{- $seriesPage := index $currentSeries 0 }}
  
  <!-- Series 信息卡片 -->
  <div class="bg-accent/30 border-accent/50 mb-6 rounded-xl border p-5">
    <div class="flex flex-col gap-4">
      <!-- Series 标题和进度 -->
      <div class="flex items-start justify-between gap-4">
        <div class="flex items-start gap-3 min-w-0 flex-1">
          <div class="flex-shrink-0 mt-0.5">
            {{ partial "features/icon.html" (dict "name" "book-open" "size" "md" "ariaLabel" "") }}
          </div>
          <div class="min-w-0 flex-1">
            <div class="flex items-center gap-2 mb-1">
              <span class="text-muted-foreground text-xs font-medium uppercase tracking-wide">
                {{ i18n "series.title" | default "系列文章" }}
              </span>
              {{- if and $showProgress (gt $totalCount 0) }}
                <span class="bg-accent text-accent-foreground rounded-full px-2 py-0.5 text-xs font-semibold">
                  {{ $currentIndex }}/{{ $totalCount }}
                </span>
              {{- end }}
            </div>
            <a
              href="{{ $seriesPage.RelPermalink }}"
              class="text-foreground hover:text-primary text-lg font-semibold transition-colors duration-200 line-clamp-2">
              {{ $seriesPage.LinkTitle }}
            </a>
            {{- if $seriesPage.Params.description }}
              <p class="text-muted-foreground mt-2 text-sm line-clamp-2">
                {{ $seriesPage.Params.description }}
              </p>
            {{- end }}
          </div>
        </div>
        
        <!-- 查看全部链接 -->
        <a
          href="{{ $seriesPage.RelPermalink }}"
          class="text-primary hover:bg-primary/10 flex-shrink-0 flex items-center gap-1 rounded-lg px-3 py-1.5 text-sm font-medium transition-all duration-200 hover:scale-105"
          aria-label="{{ i18n "series.view_all" | default "查看全部" }}">
          <span class="hidden sm:inline">{{ i18n "series.view_all" | default "查看全部" }}</span>
          {{ partial "features/icon.html" (dict "name" "arrow-right" "size" "sm" "ariaLabel" "") }}
        </a>
      </div>

      <!-- 上一篇/下一篇快速导航 -->
      {{- if or $prevPage $nextPage }}
        <div class="border-border flex items-center gap-2 border-t pt-4">
          <!-- 上一篇 -->
          {{- if $prevPage }}
            <a
              href="{{ $prevPage.RelPermalink }}"
              class="text-muted-foreground hover:text-primary hover:bg-muted/50 flex flex-1 items-center gap-2 rounded-lg px-3 py-2 text-sm transition-all duration-200 hover:scale-[1.02]"
              title="{{ $prevPage.Title }}">
              {{ partial "features/icon.html" (dict "name" "chevron-left" "size" "sm" "ariaLabel" "") }}
              <div class="min-w-0 flex-1">
                <div class="text-xs opacity-70">{{ i18n "series.previous" | default "上一篇" }}</div>
                <div class="truncate font-medium">{{ $prevPage.Title }}</div>
              </div>
            </a>
          {{- else }}
            <div class="flex-1"></div>
          {{- end }}

          <!-- 分隔符 -->
          <div class="border-border h-12 w-px border-l"></div>

          <!-- 下一篇 -->
          {{- if $nextPage }}
            <a
              href="{{ $nextPage.RelPermalink }}"
              class="text-muted-foreground hover:text-primary hover:bg-muted/50 flex flex-1 items-center gap-2 rounded-lg px-3 py-2 text-sm transition-all duration-200 hover:scale-[1.02]"
              title="{{ $nextPage.Title }}">
              <div class="min-w-0 flex-1 text-right">
                <div class="text-xs opacity-70">{{ i18n "series.next" | default "下一篇" }}</div>
                <div class="truncate font-medium">{{ $nextPage.Title }}</div>
              </div>
              {{ partial "features/icon.html" (dict "name" "chevron-right" "size" "sm" "ariaLabel" "") }}
            </a>
          {{- else }}
            <div class="flex-1"></div>
          {{- end }}
        </div>
      {{- end }}
    </div>
  </div>
{{- end }}

